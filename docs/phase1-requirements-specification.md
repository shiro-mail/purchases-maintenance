# Phase 1: 要件定義・業務分析
## 購入管理・保守管理システム 仕様書

### 1. 概要

本システムは購入管理と保守管理を統合したWebアプリケーションです。現在のシステムを仕様固定アプローチで再設計し、技術的負債を解消して統一されたアーキテクチャを構築します。

### 2. ユーザーペルソナ

#### 2.1 調達担当者
- **役割**: 購入データの取込・確認・管理
- **主要業務**: JSONファイル/PNG画像からのデータ取込、基本情報の確認・編集
- **技術レベル**: 中級（Webアプリケーション操作に慣れている）

#### 2.2 保守管理者
- **役割**: 部品情報の管理・メンテナンス
- **主要業務**: 部品詳細の確認・編集、在庫管理
- **技術レベル**: 中級

#### 2.3 データ入力オペレーター
- **役割**: 大量データの一括処理・確認
- **主要業務**: チェックボックスを使った一括選択・保存操作
- **技術レベル**: 初級〜中級

### 3. 現在の業務フロー分析

#### 3.1 データ取込プロセス
1. **JSONファイル取込**
   - ファイル選択 → アップロード → データ解析 → プレビュー表示
   - 対応形式: 標準JSON、Dify形式JSON（マークダウン内JSON）

2. **PNG画像取込（Dify API連携）**
   - 画像選択（複数選択可） → Dify APIアップロード → OCR処理 → データ抽出 → プレビュー表示

#### 3.2 基本情報管理プロセス
- **表示項目**: ページ、出荷日、受注番号、納入先番号、担当者、運賃、部品合計、税抜合計
- **操作**: 個別編集、個別削除、一括選択、一括保存
- **計算ロジック**: 
  - 部品合計 = Σ(部品の売上金額)
  - 税抜合計 = 運賃 + 部品合計

#### 3.3 部品情報管理プロセス
- **表示項目**: 部品番号、部品名、数量、売上単価、売上金額
- **操作**: 詳細表示、編集、削除

#### 3.4 仕入一覧表示プロセス
- **機能**: 保存済みデータの一覧表示、検索、フィルタリング

### 4. 新規要件（ユーザー追加要求）

#### 4.1 基本情報管理項目の明確化
- **部品合計フィールド**: 部品の「売上金額」の合計を表示
- **税抜合計フィールド**: 「運賃」＋「部品合計」の計算結果を表示
- **表示順序**: ページ、出荷日、受注番号、納入先番号、担当者、運賃、部品合計、税抜合計

#### 4.2 チェックボックス機能強化
- **全選択機能**: テーブルヘッダーにマスターチェックボックスを配置
- **全解除機能**: マスターチェックボックスで全行の選択を解除
- **連動機能**: 
  - マスターチェックボックス → 全行チェックボックス連動
  - 全行チェックボックス → マスターチェックボックス状態更新
- **視覚的フィードバック**: 部分選択時の中間状態表示

### 5. 現在システムの技術的課題

#### 5.1 データ変換の複雑性
- **問題**: 複数のデータ形式（JSON、Dify出力）を統一形式に変換する処理が複雑
- **影響**: メンテナンス性の低下、バグの発生
- **解決方針**: 統一されたデータモデルとバリデーション戦略

#### 5.2 エラーハンドリングの分散
- **問題**: 各APIエンドポイントで個別のエラー処理が実装
- **影響**: 一貫性のないエラーメッセージ、デバッグの困難
- **解決方針**: 統一されたエラーハンドリング戦略

#### 5.3 データ整合性の課題
- **問題**: フロントエンドとバックエンドで異なるデータ形式を使用
- **影響**: データ同期エラー、計算結果の不整合
- **解決方針**: 統一されたAPIスキーマとバリデーション

#### 5.4 状態管理の複雑さ
- **問題**: LocalStorageとデータベース間の同期処理が複雑
- **影響**: データ損失のリスク、ユーザビリティの低下
- **解決方針**: 明確な状態管理戦略とデータフロー設計

### 6. 外部システム連携要件

#### 6.1 Dify API統合
- **目的**: PNG画像からの請求書データ抽出
- **API仕様**: 
  - ベースURL: https://api.dify.ai
  - 認証: Bearer Token
  - ワークフローID: ed1cebe9-c907-4769-b1ac-e0e23aa6cff7
- **処理フロー**: ファイルアップロード → ワークフロー実行 → 結果取得 → データ変換

### 7. 非機能要件

#### 7.1 パフォーマンス要件
- **レスポンス時間**: 通常操作 < 2秒、データ取込 < 30秒
- **同時接続数**: 最大10ユーザー
- **データ量**: 基本情報 10,000件、部品情報 100,000件まで対応

#### 7.2 可用性要件
- **稼働時間**: 平日 8:00-18:00 (99%以上)
- **バックアップ**: 日次自動バックアップ
- **復旧時間**: 4時間以内

#### 7.3 セキュリティ要件
- **認証**: 基本認証またはセッション管理
- **データ保護**: SQLインジェクション対策、XSS対策
- **API保護**: レート制限、入力値検証

### 8. 制約事項

#### 8.1 技術制約
- **データベース**: SQLite（将来的にPostgreSQLへ移行可能な設計）
- **フレームワーク**: Flask（Python）
- **フロントエンド**: Vanilla JavaScript（将来的にReact等への移行を考慮）

#### 8.2 業務制約
- **データ形式**: 既存のJSONフォーマットとの互換性維持
- **Dify API**: 現在の契約内容での利用継続
- **移行期間**: 段階的移行によるサービス停止時間の最小化

### 9. 成功基準

#### 9.1 機能面
- [ ] 全選択/全解除チェックボックス機能の実装
- [ ] 部品合計・税抜合計の正確な計算・表示
- [ ] JSONファイル取込の安定動作
- [ ] PNG画像取込（Dify API）の安定動作
- [ ] データの整合性確保

#### 9.2 技術面
- [ ] 統一されたエラーハンドリング
- [ ] 一貫したAPIレスポンス形式
- [ ] コードの可読性・保守性向上
- [ ] テストカバレッジ80%以上

#### 9.3 ユーザビリティ面
- [ ] 操作の直感性向上
- [ ] エラーメッセージの分かりやすさ
- [ ] レスポンス時間の改善
- [ ] データ入力効率の向上

### 10. 次フェーズへの移行条件

1. 本要件定義書の承認
2. データモデル設計書の完成
3. API仕様書の完成
4. UI/UX設計書の完成
5. アーキテクチャ設計書の完成
6. 実装計画書の承認

---

**作成日**: 2025年8月11日  
**バージョン**: 1.0  
**承認者**: 衣斐司郎様
